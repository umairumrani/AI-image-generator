<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Image Generator</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <style>
    .hidden {
      display: none;
    }
    #loading-spinner {
      border: 4px solid rgba(0, 0, 0, 0.1);
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border-left-color: #4f46e5;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .history-item {
      transition: transform 0.2s;
    }
    .history-item:hover {
      transform: scale(1.02);
    }
  </style>
</head>
<body class="bg-gray-100 min-h-screen">
  <div class="container mx-auto px-4 py-8 max-w-6xl">
    <header class="text-center mb-12">
      <h1 class="text-4xl font-bold text-indigo-600 mb-2">AI Image Generator</h1>
      <p class="text-gray-600">Create stunning images with AI</p>
    </header>
    
    <div class="bg-white rounded-lg shadow-md p-6 mb-8">
      <form id="generate-form" class="mb-6">
        <div class="flex flex-col md:flex-row gap-4">
          <input
            type="text"
            id="prompt-input"
            placeholder="Enter a detailed description of the image you want to generate..."
            class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
          />
          <button
            type="submit"
            id="generate-button"
            class="bg-indigo-600 text-white px-6 py-3 rounded-lg hover:bg-indigo-700 transition-colors"
          >
            Generate
          </button>
        </div>
        <p id="error-message" class="mt-2 text-red-600 hidden"></p>
      </form>
      
      <div class="mt-8">
        <div id="loading-container" class="flex flex-col items-center justify-center py-12 hidden">
          <div class="flex items-center">
            <div id="loading-spinner"></div>
            <p class="ml-4 text-lg text-gray-700">Creating your image...</p>
          </div>
          <p class="text-sm text-gray-500 mt-4">This may take a moment</p>
        </div>
        
        <div id="image-container" class="text-center hidden">
          <img
            id="result-image"
            src=""
            alt=""
            class="mx-auto max-h-96 rounded-lg shadow-md"
          />
          <p id="result-prompt" class="mt-4 text-gray-700"></p>
        </div>
        
        <div id="placeholder-container" class="text-center py-12 bg-gray-50 rounded-lg">
          <p class="text-gray-500">Your generated image will appear here</p>
        </div>
      </div>
    </div>
    
    <div id="history-container" class="mt-12 hidden">
      <h2 class="text-2xl font-bold text-gray-900 mb-6">Generation History</h2>
      <div id="history-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        <!-- History items will be added here -->
      </div>
    </div>
  </div>

  <!-- Hidden iframe for API calls -->
  <iframe id="api-frame" style="display:none;"></iframe>

  <script>
    // Store history in localStorage
    let imageHistory = [];
    
    // Load history from localStorage
    try {
      const savedHistory = localStorage.getItem('imageHistory');
      if (savedHistory) {
        imageHistory = JSON.parse(savedHistory);
        updateHistoryDisplay();
      }
    } catch (err) {
      console.error('Error loading history:', err);
    }
    
    // Form elements
    const generateForm = document.getElementById('generate-form');
    const promptInput = document.getElementById('prompt-input');
    const generateButton = document.getElementById('generate-button');
    const errorMessage = document.getElementById('error-message');
    
    // Display containers
    const loadingContainer = document.getElementById('loading-container');
    const imageContainer = document.getElementById('image-container');
    const placeholderContainer = document.getElementById('placeholder-container');
    const historyContainer = document.getElementById('history-container');
    
    // Result elements
    const resultImage = document.getElementById('result-image');
    const resultPrompt = document.getElementById('result-prompt');
    
    // API iframe
    const apiFrame = document.getElementById('api-frame');
    
    // Handle form submission
    generateForm.addEventListener('submit', function(e) {
      e.preventDefault();
      
      const prompt = promptInput.value.trim();
      
      if (!prompt) {
        showError('Please enter a prompt');
        return;
      }
      
      generateImage(prompt);
    });
    
    // Generate image function
    function generateImage(prompt) {
      // Show loading state
      showLoading();
      hideError();
      
      // Create a simple HTML document with the API call
      const apiKey = 'sk-lKVFlxV2g1QDr0wTPVwz9nzFEbmyH1SGIY1RytHAo9xgazTF';
      
      // Create HTML content for the iframe
      const iframeContent = `
        <!DOCTYPE html>
        <html>
        <body>
          <script>
            async function callAPI() {
              try {
                const response = await fetch('https://api.stability.ai/v1/generation/stable-diffusion-xl-1024-v1-0/text-to-image', {
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ${apiKey}',
                    'Accept': 'application/json'
                  },
                  body: JSON.stringify({
                    text_prompts: [
                      {
                        text: "${prompt.replace(/"/g, '\\"')}",
                        weight: 1
                      }
                    ],
                    cfg_scale: 7,
                    height: 1024,
                    width: 1024,
                    samples: 1,
                    steps: 25,
                  })
                });
                
                if (!response.ok) {
                  const errorData = await response.json().catch(() => ({}));
                  throw new Error(errorData.message || \`API request failed with status \${response.status}\`);
                }
                
                const data = await response.json();
                
                // Send the result back to the parent window
                window.parent.postMessage({
                  type: 'result',
                  imageData: data.artifacts[0].base64,
                  prompt: "${prompt.replace(/"/g, '\\"')}"
                }, '*');
              } catch (error) {
                // Send the error back to the parent window
                window.parent.postMessage({
                  type: 'error',
                  message: error.message || 'Failed to generate image'
                }, '*');
              }
            }
            
            // Call the API
            callAPI();
          </script>
        </body>
        </html>
      `;
      
      // Set up message listener
      window.addEventListener('message', handleApiResponse);
      
      // Load the iframe with the API call
      const blob = new Blob([iframeContent], { type: 'text/html' });
      apiFrame.src = URL.createObjectURL(blob);
    }
    
    // Handle API response
    function handleApiResponse(event) {
      const { type, imageData, prompt, message } = event.data;
      
      if (type === 'result') {
        // Create image URL
        const imageUrl = `data:image/png;base64,${imageData}`;
        
        // Update the UI
        resultImage.src = imageUrl;
        resultImage.alt = prompt;
        resultPrompt.textContent = prompt;
        
        // Add to history
        const newHistoryItem = {
          id: Date.now(),
          prompt,
          imageUrl,
          timestamp: new Date().toISOString()
        };
        
        imageHistory.unshift(newHistoryItem);
        
        // Save to localStorage
        try {
          localStorage.setItem('imageHistory', JSON.stringify(imageHistory));
        } catch (err) {
          console.error('Error saving history:', err);
        }
        
        // Update history display
        updateHistoryDisplay();
        
        // Show the image
        hideLoading();
        showImage();
      } else if (type === 'error') {
        // Show error
        hideLoading();
        showError(message);
      }
      
      // Remove the message listener
      window.removeEventListener('message', handleApiResponse);
    }
    
    // Update history display
    function updateHistoryDisplay() {
      if (imageHistory.length === 0) {
        historyContainer.classList.add('hidden');
        return;
      }
      
      // Show history container
      historyContainer.classList.remove('hidden');
      
      // Get history grid
      const historyGrid = document.getElementById('history-grid');
      
      // Clear existing items
      historyGrid.innerHTML = '';
      
      // Add history items
      imageHistory.forEach(item => {
        const historyItem = document.createElement('div');
        historyItem.className = 'bg-white rounded-lg shadow-md overflow-hidden history-item';
        historyItem.innerHTML = `
          <img 
            src="${item.imageUrl}" 
            alt="${item.prompt}" 
            class="w-full h-64 object-cover"
          />
          <div class="p-4">
            <p class="text-gray-700 text-sm mb-2">${formatDate(item.timestamp)}</p>
            <p class="text-gray-900 font-medium">${item.prompt}</p>
          </div>
        `;
        historyGrid.appendChild(historyItem);
      });
    }
    
    // Format date
    function formatDate(dateString) {
      const date = new Date(dateString);
      return date.toLocaleString();
    }
    
    // UI helper functions
    function showLoading() {
      loadingContainer.classList.remove('hidden');
      imageContainer.classList.add('hidden');
      placeholderContainer.classList.add('hidden');
      generateButton.disabled = true;
      generateButton.classList.add('bg-indigo-400');
      generateButton.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
    }
    
    function hideLoading() {
      loadingContainer.classList.add('hidden');
      generateButton.disabled = false;
      generateButton.classList.remove('bg-indigo-400');
      generateButton.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
    }
    
    function showImage() {
      imageContainer.classList.remove('hidden');
      placeholderContainer.classList.add('hidden');
    }
    
    function showError(message) {
      errorMessage.textContent = message;
      errorMessage.classList.remove('hidden');
    }
    
    function hideError() {
      errorMessage.textContent = '';
      errorMessage.classList.add('hidden');
    }
  </script>
</body>
</html>
